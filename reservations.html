<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Restaurant Reservation</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="reservations.css">

</head>
<body>

<!-- Navigation -->
<nav class="top-nav">
    <div class="logo"><a href="index.html">Momo Sushi</a></div>
    <div class="nav-links">
      <a href="./menu.html">Menu</a>
      <a href="./reservations.html">Reserve</a>
      <a href="./reviews.html">Reviews</a>
      <a href="./contact.html">Contact</a>
      <a href="./aboutus.html">About</a>
      <a href="login.html" id="main-auth-link">Login</a>
      <div class="dropdown">
        <div class="menu-toggle">☰</div>
        <div class="dropdown-content">
          <a href="./profile.html" id="userProfileStatus">Not signed in</a>
          <a href="./menu.html">Menu</a>
          <a href="./menu.html">Order Now</a>
          <a href="./deals.html">Deals</a>
          <a href="./rewards.html">Rewards</a>
          <a href="./reservations.html">Reservation</a>
          <a href="./reviews.html">Reviews</a>
          <a href="./contact.html">Contact</a>
          <a href="./aboutus.html">About</a>
          <a href="login.html" id="dropdown-auth-link">Login</a>
        </div>
      </div>
    </div>
  </nav>

<header>
  <h1>Restaurant Reservation</h1>
  <p>Reserve a table or merge tables at our restaurant</p>
</header>

<div class="container">
  <h2>Choose Your Table</h2>
  <div class="tables-container" id="tablesContainer"></div>

  <h3>Reservation Form</h3>
  <form id="reservationForm">
    <label for="name">Full Name</label>
    <input type="text" id="name" required>
    <label for="email">Email Address</label>
    <input type="email" id="email" required>
    <label for="phone">Phone Number</label>
    <input type="tel" id="phone" required>
    <label for="date">Reservation Date</label>
    <input type="date" id="date" required>
    <label for="time">Reservation Time</label>
    <input type="time" id="time" required>

    <label for="guests">Number of Guests</label>
    <input type="number" id="guests" min="1" max="20" value="1" required>

    <label for="merge">Would you like to merge two tables?</label>
    <select id="merge" onchange="toggleMergeOption()">
      <option value="no">No</option>
      <option value="yes">Yes</option>
    </select>

    <div id="mergeTables" style="display:none;">
      <label for="tableSelection">Select Second Table</label>
      <select id="tableSelection">
        ${[...Array(8).keys()].map(i => `<option value="${i + 1}">Table ${i + 1}</option>`).join('')}
      </select>
    </div>

    <button type="submit">Reserve Table</button>
  </form>

  <div id="confirmationMessage" class="confirmation"></div>
</div>

<script type="module">
  import { auth } from './FirebaseConfig.js';
  import {
    getFirestore, collection, addDoc, getDocs, Timestamp
  } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

  const db = getFirestore();
  let selectedTable = null;
  const reservations = [];

  const tablesContainer = document.getElementById('tablesContainer');
  for (let i = 1; i <= 8; i++) {
    const div = document.createElement('div');
    div.className = "table available";
    div.id = "table" + i;
    div.innerText = "Table " + i;
    div.onclick = () => selectTable(i);
    tablesContainer.appendChild(div);
  }

  function selectTable(id) {
    if (document.getElementById("table" + id).classList.contains("reserved")) return;
    if (selectedTable !== null) {
      document.getElementById("table" + selectedTable).classList.remove("selected");
    }
    selectedTable = id;
    document.getElementById("table" + id).classList.add("selected");
  }

  window.toggleMergeOption = () => {
    const merge = document.getElementById("merge").value;
    document.getElementById("mergeTables").style.display = merge === "yes" ? "block" : "none";
  };

  document.getElementById("reservationForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;
    const key = `table${selectedTable}_${date}T${time}`;

    const existing = reservations.find(r => r.key === key || (r.mergeKey && r.mergeKey === key));

    const name = document.getElementById("name").value;
    const email = document.getElementById("email").value;
    const phone = document.getElementById("phone").value;
    const guests = document.getElementById("guests").value;
    const merge = document.getElementById("merge").value === "yes";
    const mergeWith = merge ? parseInt(document.getElementById("tableSelection").value) : null;
    const mergeKey = mergeWith ? `table${mergeWith}_${date}T${time}` : null;

    const data = {
      name, email, phone, guests,
      date, time,
      table: selectedTable,
      mergeWith,
      key,
      mergeKey,
      createdAt: Timestamp.now()
    };

    await addDoc(collection(db, "Reservations"), data);
    document.getElementById("confirmationMessage").innerHTML = `<h3>Reservation Confirmed!</h3><p>Table ${selectedTable}${mergeWith ? " & Table " + mergeWith : ""} reserved.</p>`;
    document.getElementById("reservationForm").reset();
    document.getElementById("table" + selectedTable).classList.remove("selected");
  });

  const snapshot = await getDocs(collection(db, "Reservations"));
  snapshot.forEach(doc => {
    const d = doc.data();
    reservations.push({
      table: d.table,
      date: d.date,
      time: d.time,
      key: `table${d.table}_${d.date}T${d.time}`,
      mergeKey: d.mergeWith ? `table${d.mergeWith}_${d.date}T${d.time}` : null
    });
  });

  function handleLogout(e) {
    e.preventDefault();
    signOut(auth).then(() => window.location.href = "login.html");
  }

  onAuthStateChanged(auth, (user) => {
    const mainAuthLink = document.getElementById("main-auth-link");
    const dropdownAuthLink = document.getElementById("dropdown-auth-link");
    const profileLink = document.getElementById("userProfileStatus");

    if (user) {
      mainAuthLink.textContent = "Logout";
      mainAuthLink.href = "#";
      mainAuthLink.onclick = handleLogout;
      dropdownAuthLink.textContent = "Logout";
      dropdownAuthLink.href = "#";
      dropdownAuthLink.onclick = handleLogout;
      profileLink.textContent = user.displayName || user.email;
      profileLink.href = "./account.html";
    } else {
      mainAuthLink.textContent = "Login";
      mainAuthLink.href = "login.html";
      dropdownAuthLink.textContent = "Login";
      dropdownAuthLink.href = "login.html";
      profileLink.textContent = "Not signed in";
      profileLink.href = "login.html";
    }
  });
</script>
<!-- Dropdown Toggle Logic -->
<script>
  document.querySelector(".menu-toggle").addEventListener("click", () => {
    document.querySelector(".dropdown").classList.toggle("active");
  });
  window.addEventListener("click", (event) => {
    if (!event.target.matches(".menu-toggle")) {
      const dropdown = document.querySelector(".dropdown");
      if (dropdown.classList.contains("active")) {
        dropdown.classList.remove("active");
      }
    }
  });
</script>
<footer class="site-footer">
    <div class="footer-container">
      <div class="footer-logo">
        <a href="index.html">Momo Sushi</a>
      </div>
      <div class="footer-links">
        <a href="menu.html">Menu</a>
        <a href="reservations.html">Reserve</a>
        <a href="contact.html">Contact</a>
        <a href="reviews.html">Reviews</a>
        <a href="aboutus.html">About</a>
      </div>
      <p class="footer-note">© 2025 Momo Sushi · All rights reserved</p>
    </div>
  </footer>
  
</body>
</html>
